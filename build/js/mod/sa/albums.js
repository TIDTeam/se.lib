/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com - Git: https://github.com/zwlijun/se.lib */
define(function(require,exports,module){require("mod/zepto/touch");var a=require("mod/sa/lightanimation"),b=require("mod/se/listener"),c=require("mod/se/util"),d=require("mod/polyfill/css"),e="ontouchstart"in window,f=e?"touchstart":"mousedown",g=e?"touchmove":"mousemove",h=e?"touchend":"mouseup",i=d.hasProperty("perspective")?"translateZ(0)":"",j={},k={albums:{show:function(b,c){var d=c.parent(),e=d.parent(),f=e.attr("id"),g=$(e.attr("data-relative")),h=g.offset(),i=d.offset(),k=d.find('[data-type="photos"]'),l=k.attr("data-in"),m=j[f];k.css({left:h.left-i.left+"px",top:h.top-i.top+"px",width:h.width+"px",height:h.height+"px"}),m.currentIndex=0,m.photos=k,m.photoList=k.find('[data-type="photo"]'),m.resetPhotoList(),k.removeClass("hide"),m.exec("show",[]),setTimeout(function(){a.newInstance(k,l).play()},60)}}},l=function(a,c){this.id=a,this.albums=$("#"+a),this.relative=c||"body",this.albumList=this.albums.find('[data-type="album"]'),this.albumSize=this.albumList.length,this.currentIndex=0,this.nextIndex=0,this.prevIndex=0,this.lastIndex=0,this.currentZIndex=4,this.nextZIndex=3,this.prevZIndex=2,this.queueZIndex=1,this.photos=null,this.photoList=[],this.listener=new b({onshow:null,onhidden:null})};l.prototype={exec:function(a,b){return this.listener.exec(a,b)},set:function(a,b){this.listener.set(a,b)},remove:function(a){this.listener.remove(a)},get:function(a){return this.listener.get(a)},clear:function(){this.listener.clear()},getPointerPosition:function(a){a.changedTouches&&(a=a.changedTouches[a.changedTouches.length-1]);var b=0,c=0,d=a.clientX,e=a.clientY,f=document.body,g=f.scrollLeft,h=f.scrollTop,i=$(a.target),j=i.offset();return b=(d+g||a.pageX)-j.left||0,c=(e+h||a.pageY)-j.top||0,{x:b,y:c}},resetPhotoList:function(){for(var a=this.photoList,b=a.length,c=null,e=(this.photos.attr("data-scroll"),this.currentIndex),f=this.lastIndex=b-1,g=this.nextIndex=e+1>f?0:e+1,h=this.prevIndex=0>e-1?f:e-1,j=0;b>j;j++)c=$(a[j]),c.css("visibility","hidden"),c.css("opacity",1),j===e?(c.css("z-index",this.currentZIndex),c.css("visibility","visible")):j===g?(c.css("z-index",this.nextZIndex),c.css("visibility","visible")):j===h&&(c.css("z-index",this.prevZIndex),c.css("visibility","visible")),d.css(c,"transform","translate(0, 0) "+i)},bind:function(){var b=this,c=b.albums.find('[data-type="photos"]');$.each(c,function(c,d){var e=0,i=0,j=0,k=0,l=$(d);l.on(f,"",b,function(a){var b=a.data,c=b.getPointerPosition(a);e=c.x,i=c.y}).on(g,"",b,function(a){var b=a.data,c=b.getPointerPosition(a);j=c.x,k=c.y}).on(h,"",b,function(b){var c=b.data,d=c.getPointerPosition(b),f=l.attr("data-scroll"),g=Number(l.attr("data-hidden")||50),h=!1,m=c.photoList[c.currentIndex],n=null,o="!.5s ease-out;opacity:0!.4s ease-out",p=!1;if(j=d.x,k=d.y,"h"==f?(h=Math.abs(k-i)>=g,n="transition::translate:"+(j-e>0?"100%,0":"-100%,0")+o,p=Math.abs(j-e)>10):(h=Math.abs(j-e)>=g,n="transition::translate:"+(k-i>0?"0,100%":"0,-100%")+o,p=Math.abs(k-i)>10),h)l.one("webkitTransitionEnd",function(a){a.stopPropagation(),l.addClass("hide"),c.exec("hidden",[])}),l.css("opacity",0);else{if(!p)return 0;a.newInstance(m,n).set("complete",{callback:function(){++this.currentIndex,this.currentIndex>=this.photoList.length&&(this.currentIndex=0),this.resetPhotoList()},context:c}).play()}})})},create:function(){var b=this,d=b.albums.attr("data-in");if(d){var e=a.newInstance(b.albums,d);e.play()}b.albums.attr("data-relative",b.relative),j[b.id]=b,b.bind(),c.setActionHook(b.albums),c.injectAction(k)},destroy:function(){delete j[this.id]}},module.exports={newInstance:function(a,b){var c=new l(a,b);return{set:function(a,b){return c.set(a,b),this},create:function(){return c.create(),this},destroy:function(){return c.destroy(),this}}}}});