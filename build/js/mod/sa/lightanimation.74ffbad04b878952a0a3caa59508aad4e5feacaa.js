/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com - Git: https://github.com/zwlijun/se.lib */
define(function(require,exports,module){require("mod/polyfill/array.d61415d0b8186b13d02105fe8e4fb27369d07a21");var a=require("mod/polyfill/css.dd4f56f0caedb23a7e61c1d33b666970c4c6dada"),b=require("mod/se/listener.263f38898829bcbd37b39b7743be119a9db33581"),c=a.getRealPropertyName("transform"),d=a.getRealPropertyName("transition"),e=a.getRealPropertyName("animation"),f=function(a){this.name=a,this.frames=[]};f.prototype={push:function(b,d){if(-1==this.frames.indexOf(b)){var e=[],f="",g="",h=[];for(var i in d)d.hasOwnProperty(i)&&(g=d[i],a.isTransformMethod(i)?h.push(i+"("+g+")"):(f=a.getRealPropertyName(i),e.push(f+": "+g)));h.length>0&&e.push(c+": "+h.join(" ")),this.frames.push(b+" {"+e.join("; ")+"}")}},print:function(){var b=this.frames.join("\n"),c="keyframes",d=this.name,e=a.getVendorHackKey()+c,f=" "+d+" {\n"+b+"\n}",g=[];e!=c&&g.push("@"+e+f),g.push("@"+c+f),$("head").append('<style type="text/css">\n'+g.join("\n")+"\n</style>")}};var g=function(a,c,d){this.target=$(a),this.domNode=this.target[0],this.backupStyle=this.domNode.style.cssText,this.runtimeStyle=this.backupStyle,this.source=c,this.current=0,this.queue=this.parse(c),this.keyframes={},this.animationIndex=0,this.listener=new b({ontransitionEnd:null,onanimationStart:null,onanimationEnd:null,onanimationIteration:null,oncomplete:null}),!1!==d&&this.on()};g.prototype={exec:function(a,b){return this.listener.exec(a,b)},set:function(a,b){this.listener.set(a,b)},remove:function(a){this.listener.remove(a)},get:function(a){return this.listener.get(a)},clear:function(){this.listener.clear()},off:function(){var a=this,b=a.target;b.off("webkitAnimationStart","").off("webkitAnimationEnd","").off("webkitAnimationIteration","").off("webkitTransitionEnd","")},on:function(a){var b=this,c=b.target,d=c.attr("data-bindla");("1"!=d||!0===a)&&(b.off(),c.on("webkitAnimationStart","",b,function(a){var b=a.data;b.animationStart(a)}),c.on("webkitAnimationEnd","",b,function(a){var b=a.data;b.animationEnd(a)}),c.on("webkitAnimationIteration","",b,function(a){var b=a.data;b.animationIteration(a)}),c.on("webkitTransitionEnd","",b,function(a){var b=a.data;b.transitionEnd(a)}))},animationStart:function(b){b.preventDefault(),b.stopPropagation();var c=this;c.exec("animationStart",[c.target,c.current]);var d="animationIterationCount",e=a.getRealStyle(d),f=c.domNode.style[d];e&&(f=c.domNode.style[e]),"infinite"==f&&(c.current++,c.__play__())},animationEnd:function(a){a.preventDefault(),a.stopPropagation();var b=this;b.exec("animationEnd",[b.target,b.current]),b.current++,b.__play__()},animationIteration:function(a){a.preventDefault(),a.stopPropagation();var b=this;b.exec("animationIteration",[b.target,b.current])},transitionEnd:function(b){b.preventDefault(),b.stopPropagation();var c=this,d=c.target,e=d.css(a.getRealStyle("transition")),f=e.split(",").length,g=++c.animationIndex;f==g&&(c.exec("transitionEnd",[d,c.current]),c.current++,c.animationIndex=0,c.__play__())},parse:function(a){var b="::",c=a.indexOf(b),d=a.substring(0,c),e=a.substr(c+b.length);if("transition"==d)return this.parseTransition(e);if("animation"==d)return this.parseAnimation(e);throw new Error("Unknown animation schema("+d+")")},parseTransition:function(b){for(var e=b.split(">"),f=e.length,g=null,h=null,i=/^([^:]+):([^!]+)!(.+)?$/g,j=null,k=null,l=[],m=!1,n=[],o=0;f>o;o++){l=[],m=!1,g=e[o],k={properties:[],values:[],animate:[]},h=g.split(";");for(var p=0,q=h.length;q>p;p++)for(;null!=(j=i.exec(h[p]));){var r=j[1],s=j[2],t=j[3]||"",u=a.getRealPropertyName(r),v=a.cssname(u);a.isTransformMethod(r)?(l.push(r+"("+s+")"),t&&!1===m&&(k.values.push(c+" "+t),m=!0)):(k.properties.push(v+": "+s),t&&k.values.push(v+" "+t))}l.length>0&&k.properties.push(c+": "+l.join(" ")),k.animate.push(d+": "+k.values.join(", ")),n.push(k)}return n},parseAnimation:function(a){for(var b=a.split(">"),c=b.length,d=null,f=null,g=/^([^:]+):([^!]*)!(.+)?$/g,h=null,i=null,j=[],k=0;c>k;k++){d=b[k],i={properties:[],values:[],animate:[]},f=d.split(";");for(var l=0,m=f.length;m>l;l++)for(;null!=(h=g.exec(f));){var n=h[1],o=(h[2],h[3]||"");i.values.push(n+" "+o)}i.animate.push(e+": "+i.values.join(", ")),j.push(i)}return j},clearKeyFrames:function(){this.keyframes={}},addKeyFrame:function(a,b,c){a in this.keyframes||(this.keyframes[a]=new f(a)),this.keyframes[a].push(b,c)},printKeyFrames:function(){for(var a in this.keyframes)this.keyframes[a].print()},mergerCss:function(a,b,c){var d=/(;\s*)$/g,e=a.replace(d,""),f=b.replace(d,""),g=(c||"").split(":")[1]||"",h=(e?e+";":"")+(f?f+";":"")+(g&&g.length>1?c:"");return h},__play__:function(){var a=this.queue[this.current];if(a){var b=a.properties,c=(a.values,a.animate),d=this.mergerCss(this.runtimeStyle,b.join(";"),c.join(";"));this.runtimeStyle=this.domNode.style.cssText=d}else this.exec("complete",[this.target])},updateSource:function(a){this.source=a,this.queue=this.parse(a)},updateTarget:function(a){this.target=$(a),this.domNode=this.target[0],this.backupStyle=this.domNode.style.cssText,this.runtimeStyle=this.backupStyle},play:function(){this.reset(),this.__play__()},reset:function(){this.domNode.style.cssText=this.runtimeStyle=this.backupStyle,this.animationIndex=0,this.current=0}};var h={newInstance:function(a,b,c){var d=new g(a,b,c);return{target:d.target,set:function(a,b){return d.set(a,b),this},addKeyFrame:function(a,b,c){return d.addKeyFrame(a,b,c),this},printKeyFrames:function(){return d.printKeyFrames(),this},clearKeyFrames:function(){return d.clearKeyFrames(),this},updateTarget:function(a){return d.updateTarget(a),this},source:function(a){return d.updateSource(a),this},play:function(){return setTimeout(function(){d.play()},60),this},reset:function(){return d.reset(),this},off:function(){return d.off(),this},on:function(a){return d.on(a),this}}}};module.exports=h});
