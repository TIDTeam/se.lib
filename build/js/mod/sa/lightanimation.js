/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com - Git: https://github.com/zwlijun/se.lib */
define(function(require,exports,module){require("mod/polyfill/array");var a=require("mod/se/listener"),b=["webkit","Moz","ms","O",""],c=b.length,d=document.createElement("div").style,e=/^((translate|rotate|scale)(X|Y|Z|3d)?|skew(X|Y)|matrix(3d)?|perspective)$/,f=function(){for(var a="",e="",f=0;c>f;f++)if(e=b[f],a=(e?e+"T":"t")+"ransform",a in d)return e;return void 0}(),g=function(a){return void 0===f?void 0:""===f||a in d?a:f+a.charAt(0).toUpperCase()+a.substr(1)},h=function(a){return void 0===f?void 0:""===f||a in d?a:"-"+f.toLowerCase()+"-"+i(a)},i=function(a){var b=a.replace(/([A-Z])/g,"-$1").toLowerCase();return b},j=function(a,b,c){var d=h(b);void 0===d||d==b?a.css(b,c):a.css(d,c)},k=h("transform"),l=h("transition"),m=h("animation");k=void 0===k||"transform"==k?"":k,l=void 0===l||"transition"==l?"":l,m=void 0===m||"animation"==m?"":m;var n=function(a){this.name=a,this.frames=[]};n.prototype={push:function(a,b){if(-1==this.frames.indexOf(a)){var c=[],d="",f="",g=[];for(var i in b)f=b[i],e.test(i)?g.push(i+"("+f+")"):(d=h(i),c.push(void 0!==d&&d!=i?d+": "+f:i+": "+f));g.length>0&&c.push(k?k+": "+g.join(" "):"transform: "+g.join(" ")),this.frames.push(a+" {"+c.join("; ")+"}")}},print:function(){var a=this.frames.join("\n"),b="keyframes",c=this.name,d="-"+f.toLowerCase()+"-"+b,e=" "+c+" {\n"+a+"\n}",g=[];g.push("@"+d+e),g.push("@"+b+e),$("head").append('<style type="text/css">\n'+g.join("\n")+"\n</style>")}};var o=function(b,c){this.target=$(b),this.domNode=this.target[0],this.backupStyle=this.domNode.style.cssText,this.runtimeStyle=this.backupStyle,this.source=c,this.current=0,this.queue=this.parse(c),this.keyframes={},this.listener=new a({ontransitionEnd:null,onanimationStart:null,onanimationEnd:null,onanimationIteration:null,oncomplete:null});var d=this.target.attr("data-bindla");"1"!=d&&(this.target.on("webkitAnimationStart","",this,function(a){var b=a.data;b.animationStart(a)}),this.target.on("webkitAnimationEnd","",this,function(a){var b=a.data;b.animationEnd(a)}),this.target.on("webkitAnimationIteration","",this,function(a){var b=a.data;b.animationIteration(a)}),this.target.on("webkitTransitionEnd","",this,function(a){var b=a.data;b.transitionEnd(a)}))};o.prototype={exec:function(a,b){return this.listener.exec(a,b)},set:function(a,b){this.listener.set(a,b)},remove:function(a){this.listener.remove(a)},get:function(a){return this.listener.get(a)},clear:function(){this.listener.clear()},animationStart:function(a){a.preventDefault(),a.stopPropagation();var b=this;b.exec("animationStart",[b.target,b.current]);var c="animationIterationCount",d=g(c),e=b.domNode.style[c];d&&(e=b.domNode.style[d]),"infinite"==e&&(b.current++,b.__play__())},animationEnd:function(a){a.preventDefault(),a.stopPropagation();var b=this;b.exec("animationEnd",[b.target,b.current]),b.current++,b.__play__()},animationIteration:function(a){a.preventDefault(),a.stopPropagation();var b=this;b.exec("animationIteration",[b.target,b.current])},transitionEnd:function(a){a.preventDefault(),a.stopPropagation();var b=this,c=b.target,d=c.css(g("transition")),e=d.split(",").length,f=Number(c.attr("data-subqueue")||0);e==++f&&(b.exec("transitionEnd",[c,b.current]),b.current++,b.__play__()),c.attr("data-subqueue",f)},parse:function(a){var b="::",c=a.indexOf(b),d=a.substring(0,c),e=a.substr(c+b.length);if("transition"==d)return this.parseTransition(e);if("animation"==d)return this.parseAnimation(e);throw new Error("Unknown animation schema("+d+")")},parseTransition:function(a){for(var b=a.split(">"),c=b.length,d=null,f=null,g=/^([^:]+):([^!]+)!(.+)?$/g,j=null,m=null,n=[],o=!1,p=[],q=0;c>q;q++){d=b[q],m={properties:[],values:[],animate:[]},f=d.split(";");for(var r=0,s=f.length;s>r;r++)for(;null!=(j=g.exec(f[r]));){var t=j[1],u=j[2],v=j[3]||"",w=h(t),x=i(t);w=void 0===w||w==t?"":w,e.test(t)?(n.push(t+"("+u+")"),v&&!1===o&&(m.values.push(k?k+" "+v:"transform "+v),o=!0)):(m.properties.push(w?w+": "+u:x+": "+u),v&&m.values.push(w?w+" "+v:x+" "+v))}n.length>0&&m.properties.push(k?k+": "+n.join(" "):"transform: "+n.join(" ")),m.animate.push(l?l+": "+m.values.join(", "):"transition: "+m.values.join(", ")),p.push(m)}return p},parseAnimation:function(a){for(var b=a.split(">"),c=b.length,d=null,e=null,f=/^([^:]+):([^!]*)!(.+)?$/g,g=null,h=null,i=[],j=0;c>j;j++){d=b[j],h={properties:[],values:[],animate:[]},e=d.split(";");for(var k=0,l=e.length;l>k;k++)for(;null!=(g=f.exec(e));){var n=g[1],o=(g[2],g[3]||"");h.values.push(n+" "+o)}h.animate.push(m?m+": "+h.values.join(", "):"animation: "+h.values.join(", ")),i.push(h)}return i},clearKeyFrames:function(){this.keyframes={}},addKeyFrame:function(a,b,c){a in this.keyframes||(this.keyframes[a]=new n(a)),this.keyframes[a].push(b,c)},printKeyFrames:function(){for(var a in this.keyframes)this.keyframes[a].print()},mergerCss:function(a,b,c){var d=/(;\s*)$/g,e=a.replace(d,""),f=b.replace(d,""),g=(c||"").split(":")[1]||"",h=(e?e+";":"")+(f?f+";":"")+(g&&g.length>1?c:"");return h},__play__:function(){var a=this.queue[this.current];if(a){var b=a.properties,c=(a.values,a.animate),d=this.mergerCss(this.runtimeStyle,b.join(";"),c.join(";"));this.runtimeStyle=this.domNode.style.cssText=d}else this.exec("complete",[this.target])},updateSource:function(a){this.source=a,this.queue=this.parse(a)},updateTarget:function(a){this.target=$(a),this.domNode=this.target[0],this.backupStyle=this.domNode.style.cssText,this.runtimeStyle=this.backupStyle},play:function(){this.reset(),this.__play__()},reset:function(){this.domNode.style.cssText=this.runtimeStyle=this.backupStyle,this.target.attr("data-subqueue","0"),this.current=0},remove:function(){j(this.target,"transition",""),j(this.target,"animation","")}};var p={newInstance:function(a,b){var c=new o(a,b);return{target:c.target,set:function(a,b){return c.set(a,b),this},addKeyFrame:function(a,b,d){return c.addKeyFrame(a,b,d),this},printKeyFrames:function(){return c.printKeyFrames(),this},clearKeyFrames:function(){return c.clearKeyFrames(),this},updateTarget:function(a){return c.updateTarget(a),this},source:function(a){return c.updateSource(a),this},play:function(){return c.play(),this},reset:function(){return c.reset(),this},remove:function(){return c.remove(),this}}}};module.exports=p});