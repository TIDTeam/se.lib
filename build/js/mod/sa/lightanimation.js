/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com */
define(function(require,exports,module){require("mod/polyfill/array");var a=require("mod/se/listener"),b=["webkit","Moz","ms","O",""],c=b.length,d=document.createElement("div").style,e=/^((translate|rotate|scale)(X|Y|Z|3d)?|skew(X|Y)|matrix(3d)?|perspective)$/,f=function(){for(var a="",e="",f=0;c>f;f++)if(e=b[f],a=(e?e+"T":"t")+"ransform",a in d)return e;return void 0}(),g=function(a){return void 0===f?void 0:""===f?a:f+a.charAt(0).toUpperCase()+a.substr(1)},h=function(a){return void 0===f?void 0:""===f?a:"-"+f.toLowerCase()+"-"+i(a)},i=function(a){var b=a.replace(/([A-Z])/g,"-$1").toLowerCase();return b},j=h("transform"),k=h("transition"),l=h("animation");j=void 0===j||"transform"==j?"":j,k=void 0===k||"transition"==k?"":k,l=void 0===l||"animation"==l?"":l;var m=function(a){this.name=a,this.frames=[]};m.prototype={push:function(a,b){if(-1==this.frames.indexOf(a)){var c=[],d="",f="",g=[];for(var i in b)f=b[i],e.test(i)?g.push(i+"("+f+")"):(d=h(i),void 0!==d&&d!=i&&c.push(d+": "+f),c.push(i+": "+f));g.length>0&&(j&&c.push(j+": "+g.join(" ")),c.push("transform: "+g.join(" "))),this.frames.push(a+" {"+c.join("; ")+"}")}},print:function(){var a=this.frames.join("\n"),b="keyframes",c=this.name,d="-"+f.toLowerCase()+"-"+b,e=" "+c+" {\n"+a+"\n}",g=[];g.push("@"+d+e),g.push("@"+b+e),$("head").append('<style type="text/css">'+g.join("\n")+"</style>")}};var n=function(b,c){this.target=$(b),this.domNode=this.target[0],this.backupStyle=this.domNode.style.cssText,this.runtimeStyle=this.backupStyle,this.source=c,this.current=0,this.queue=this.parse(c),this.keyframes={},this.listener=new a({ontransitionEnd:null,onanimationStart:null,onanimationEnd:null,onanimationIteration:null,oncomplete:null}),this.target.on("webkitAnimationStart","",this,function(a){var b=a.data;b.exec("animationStart",[b.target,b.current]);var c="animationIterationCount",d=g(c),e=b.domNode.style[c];d&&(e=b.domNode.style[d]),"infinite"==e&&(b.current++,b.__play__())}),this.target.on("webkitAnimationEnd","",this,function(a){var b=a.data;b.exec("animationEnd",[b.target,b.current]),b.current++,b.__play__()}),this.target.on("webkitAnimationIteration","",this,function(a){var b=a.data;b.exec("animationIteration",[b.target,b.current])}),this.target.on("webkitTransitionEnd","",this,function(a){var b=a.data;b.exec("transitionEnd",[b.target,b.current]),b.current++,b.__play__()})};n.prototype={exec:function(a,b){return this.listener.exec(a,b)},set:function(a,b){this.listener.set(a,b)},remove:function(a){this.listener.remove(a)},get:function(a){return this.listener.get(a)},clear:function(){this.listener.clear()},parse:function(a){var b="::",c=a.indexOf(b),d=a.substring(0,c),e=a.substr(c+b.length);if("transition"==d)return this.parseTransition(e);if("animation"==d)return this.parseAnimation(e);throw new Error("Unknown animation schema("+d+")")},parseTransition:function(a){for(var b=a.split(">"),c=b.length,d=null,f=null,g=/^([^:]+):([^!]+)!(.+)?$/g,l=null,m=null,n=[],o=!1,p=[],q=0;c>q;q++){d=b[q],m={properties:[],values:[],animate:[]},f=d.split(";");for(var r=0,s=f.length;s>r;r++)for(;null!=(l=g.exec(f[r]));){var t=l[1],u=l[2],v=l[3]||"",w=h(t),x=i(t);w=void 0===w||w==t?"":w,e.test(t)?(n.push(t+"("+u+")"),v&&!1===o&&(j&&m.values.push(j+" "+v),m.values.push("transform "+v))):(w&&m.properties.push(w+": "+u),m.properties.push(x+": "+u),v&&(w&&m.values.push(w+" "+v),m.values.push(x+" "+v)))}n.length>0&&(j&&m.properties.push(j+": "+n.join(" ")),m.properties.push("transform: "+n.join(" "))),k&&m.animate.push(k+": "+m.values.join(", ")),m.animate.push("transition: "+m.values.join(", ")),p.push(m)}return p},parseAnimation:function(a){for(var b=a.split(">"),c=b.length,d=null,e=null,f=/^([^:]+):([^!]*)!(.+)?$/g,g=null,h=null,i=[],j=0;c>j;j++){d=b[j],h={properties:[],values:[],animate:[]},e=d.split(";");for(var k=0,m=e.length;m>k;k++)for(;null!=(g=f.exec(e));){var n=g[1],o=(g[2],g[3]||"");h.values.push(n+" "+o)}l&&h.animate.push(l+": "+h.values.join(", ")),h.animate.push("animation: "+h.values.join(", ")),i.push(h)}return i},addKeyFrame:function(a,b,c){a in this.keyframes||(this.keyframes[a]=new m(a)),this.keyframes[a].push(b,c)},printKeyFrames:function(){for(var a in this.keyframes)this.keyframes[a].print()},__play__:function(){var a=this.queue[this.current];if(a){var b=a.properties,c=(a.values,a.animate),d=this.runtimeStyle+"; "+b.join(";")+"; "+c.join(";");this.runtimeStyle=this.domNode.style.cssText=d}},play:function(){this.domNode.style.cssText=this.runtimeStyle=this.backupStyle,this.current=0,this.__play__()}};var o={newInstance:function(a,b){var c=new n(a,b);return{set:function(a,b){return c.set(a,b),this},addKeyFrame:function(a,b,d){return c.addKeyFrame(a,b,d),this},printKeyFrames:function(){return c.printKeyFrames(),this},play:function(){c.play()}}}};module.exports=o});