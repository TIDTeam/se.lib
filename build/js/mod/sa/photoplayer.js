/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com - Git: https://github.com/zwlijun/se.lib */
define(function(require,exports,module){require("mod/zepto/touch");var a=require("mod/sa/lightanimation"),b=require("mod/sa/physical/vector2d"),c=require("mod/sa/physical/particle"),d=require("mod/sa/physical/particlesystem"),e=(require("mod/polyfill/css"),d.newInstance()),f=.5;e.effect(-window.innerWidth,-window.innerHeight,window.innerWidth,window.innerHeight);var g=function(a){if(this.playerId=a,this.player=$("#"+a),!a||1!=this.player.length)throw new Error("the player does not configure("+a+").");this.fadeinAnimation=[],this.playerAnimation=null,this.photos=[],this.size=this.photos.length,this.ready=!1,this.moving=!1,this.killed=void 0,this.count=0,this.startX=0,this.startY=0,this.startPosition=new b(this.startX,this.startY),this.stopX=0,this.stopY=0,this.stopPosition=new b(this.stopX,this.stopY),this.timer=null,this.runing=!1,this.animate=null};g.prototype={getPointerPosition:function(a){a.changedTouches&&(a=a.changedTouches[a.changedTouches.length-1]);var b=0,c=0,d=a.clientX,e=a.clientY,f=document.body,g=f.scrollLeft,h=f.scrollTop,i=$(a.target),j=i.offset();return b=(d+g||a.pageX)-j.left||0,c=(e+h||a.pageY)-j.top||0,{x:b,y:c}},sampleDirection:function(a,c){var d=Math.random(),e=a*d+c*(1-d);return new b(Math.cos(e),Math.sin(e))},sampleNumber:function(a,b){var c=Math.random();return a*c+b*(1-c)},bind:function(a){var c="ontouchstart"in window,d=c?"touchstart":"mousedown",f=c?"touchmove":"mousemove",g=c?"touchend":"mouseup";a.on(d,"",this,function(a){a.stopPropagation();var c=a.data,d=c.getPointerPosition(a);c.ready&&(void 0===c.killed||!0===c.killed)&&(c.runing||c.moving||(c.startX=d.x,c.startY=d.y,c.startPosition=new b(c.startX,c.startY),c.moving=!0,e.set("end",{callback:function(a){var b=$(a),c=Number(b.attr("data-photoIndex")),d=this.fadeinAnimation[c];d.source(this.animate),d.updateTarget(a),d.set("complete",{callback:function(a,b){var c=$(a);c.css({left:"",top:"","z-index":1,opacity:1}),this.killed=!0,0===b&&this.photos.css("z-index",2)},args:[c],context:this}),d.play(),this.runing=!1},args:[a.target],context:c})))}),a.on(f,"",this,function(a){a.stopPropagation();var b=a.data,c=b.getPointerPosition(a);b.ready&&(b.stopX=c.x,b.stopY=c.y)}),a.on(g,"",this,function(a){a.stopPropagation();{var c=a.data,d=c.getPointerPosition(a);window.innerWidth,window.innerHeight}c.ready&&(void 0===c.killed||!0===c.killed)&&(c.stopX=d.x,c.stopY=d.y,c.moving=!1,c.runing=!0,c.killed=!1,c.stopPosition=new b(c.stopX,c.stopY),c.run(a.target))})},step:function(a){var b=this,d=(b.sampleNumber(1,2),b.stopPosition.subtract(b.startPosition).multiply(10));d=d.add(b.sampleDirection(0,2*Math.PI).multiply(20)),e.emit(new c(b.stopPosition,d,1,null,0)),e.simulate(f),e.render(a,{callback:function(a,b){var c=b.position.x,d=b.position.y;this.animate="transition::left:"+c%window.innerWidth+"px!0.4s ease-out;top:"+d%window.innerHeight+"px!0.4s ease-out;opacity:0!0.4s ease-out"},context:b})},run:function(a){var b=this;!function(){b.step(a),b.runing&&(b.timer=setTimeout(arguments.callee,10))}()},create:function(){this.photos=$("#"+this.playerId+" > *"),this.size=this.photos.length,this.fadeinAnimation=[],this.count=0,this.ready=!1;var b=null,c=null,d=null;b=this.player.attr("data-in"),b&&(this.playerAnimation=a.newInstance(this.player,b),this.playerAnimation.set("complete",{callback:function(){this.playPhotos()},context:this}));for(var e=0;e<this.size;e++)c=$(this.photos[e]),b=c.attr("data-in"),d=c.attr("data-interaction")||"1",b&&(c.attr("data-photoIndex",this.fadeinAnimation.length),this.fadeinAnimation.push(a.newInstance(c,b))),"1"==d&&this.bind(c)},playPhotos:function(){for(var a=this.fadeinAnimation,b=a.length,c=0;b>c;c++)a[c].set("complete",{callback:function(a,b){this.ready=++this.count>=b},context:this,args:[b]}),a[c].play()},start:function(){var a=this;a.playerAnimation?a.playerAnimation.play():a.playPhotos()}},module.exports=g});