/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com - Git: https://github.com/zwlijun/se.lib */
define(function(require,exports,module){var a=require("mod/sa/physical/vector2d"),b=(require("mod/sa/physical/particle"),require("mod/se/listener")),c=require("mod/se/util"),d=function(){this.particles=new Array,this.gravity=new a(0,100),this.effectors=new Array,this.listener=new b({onend:null})};d.prototype={exec:function(a,b){return this.listener.exec(a,b)},set:function(a,b){this.listener.set(a,b)},remove:function(a){this.listener.remove(a)},get:function(a){return this.listener.get(a)},clear:function(){this.listener.clear()},emit:function(a){this.particles.push(a)},effect:function(a,b,c,d){this.effectors.push(new e(a,b,c,d))},setGravity:function(b,c){this.gravity=new a(b,c)},simulate:function(a){this.aging(a),this.applyGravity(),this.applyEffectors(),this.kinematics(a)},_render:function(a,b,c){var d=b;a.fillStyle="rgba("+Math.floor(255*d.color.r)+","+Math.floor(255*d.color.g)+","+Math.floor(255*d.color.b)+","+c.toFixed(2)+")",a.beginPath(),a.arc(d.position.x,d.position.y,d.size,0,2*Math.PI,!0),a.closePath(),a.fill()},render:function(a,b){var d=b||{callback:this._render};for(var e in this.particles){var f=this.particles[e],g=1-f.age/f.life;c.execAfterMergerHandler(d,[a,f,g])}},aging:function(a){for(var b=0;b<this.particles.length;){var c=this.particles[b];c.age+=a,c.age>=c.life?this.kill(b):b++}},kill:function(a){this.particles.length>1&&(this.particles[a]=this.particles[this.particles.length-1]),this.particles.pop(),this.exec("end",[])},applyGravity:function(){for(var a in this.particles)this.particles[a].acceleration=this.gravity},applyEffectors:function(){for(var a in this.effectors){var b=this.effectors[a].apply;for(var c in this.particles)b(this.particles[c])}},kinematics:function(a){for(var b in this.particles){var c=this.particles[b];c.position=c.position.add(c.velocity.multiply(a)),c.velocity=c.velocity.add(c.acceleration.multiply(a))}}};var e=function(a,b,c,d){this.x1=a,this.y1=b,this.x2=c,this.y2=d};e.prototype={apply:function(a){(a.position.x-a.size<this.x1||a.position.x+a.size>this.x2)&&(a.velocity.x=-a.velocity.x),(a.position.y-a.size<this.y1||a.position.y+a.size>this.y2)&&(a.velocity.y=-a.velocity.y)}};var f={ChamberBox:e,newInstance:function(a,b){var c=new d(a,b);return{set:function(a,b){return c.set(a,b),this},emit:function(a){return c.emit(a),this},effect:function(a,b,d,e){return c.effect(a,b,d,e),this},setGravity:function(a,b){return c.setGravity(a,b),this},simulate:function(a){return c.simulate(a),this},render:function(a,b){return c.render(a,b),this}}}};module.exports=f});