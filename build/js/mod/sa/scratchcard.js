/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com - Git: https://github.com/zwlijun/se.lib */
define(function(require,exports,module){var a=require("mod/sa/image"),b=require("mod/sa/paintbrush/fuzzyedgepencil"),c=$.Util,d=function(a){this.ImageUtil=null,this.stage=a,this.context=a.getContext("2d"),this.x=0,this.y=0,this.width=0,this.height=0,this.imageX=0,this.imageY=0,this.imageWidth=0,this.imageHeight=0,this.touched=!1,this.offsetX=this.stage.offsetLeft,this.offsetY=this.stage.offsetTop,this.brushSize=10,this.blurRadius=40,this.shadowBlur=20,this.ready=null,this.begin=null,this.processing=null,this.complete=null,this.scratchText=null,this.alpha=1,this.brush=b.createPaintBrush(a),this.setStageStyle("background-color","transparent")};d.prototype={setStageStyle:function(a,b){$(this.stage).css(a,b)},mask:function(a,b){var c=document.createElement("canvas");return c.width=a,c.height=b,c},setAlpha:function(a){this.alpha=a},setBrushSize:function(a){this.brushSize=a},setBlurRadius:function(a){this.blurRadius=a},setShadowBlur:function(a){this.shadowBlur=a},setReady:function(a){this.ready=a},setBegin:function(a){this.begin=a},setProcessing:function(a){this.processing=a},setComplete:function(a){this.complete=a||null},setScratchText:function(a){this.scratchText=a},appendText:function(a){if(a){var b=this.context;a.font&&(b.font=a.font),a.textAlign&&(b.textAlign=a.textAlign),a.textBaseline&&(b.textBaseline=a.textBaseline),a.color&&(b.fillStyle=a.color),b.fillText(a.text,a.x,a.y)}},bind:function(){{var a=this,b=a.brush,d=b.brush;a.stage}c.execAfterMergerHandler(a.ready,[]),d.setLineWidth(a.brushSize),d.addColor(1,"#000"),d.setShadowBlur(a.shadowBlur),d.setShadowColor("#000"),b.set("start",{callback:function(a){a.preventDefault(),a.stopPropagation(),c.execAfterMergerHandler(this.begin,[])},context:this}),b.set("end",{callback:function(a){a.preventDefault(),a.stopPropagation();for(var b=this,d=b.context,e=d.getImageData(b.x,b.y,b.width,b.height).data,f=0,g=0,h=0,i=e.length;i>f;f+=4)e[f]&&e[f+1]&&e[f+2]&&e[f+3]?h++:g++;c.execAfterMergerHandler(b.complete,[h,g])},context:this}),b.set("drawing",{callback:function(a,b){a.preventDefault(),a.stopPropagation();var d=b.getPointerPosition(a);c.execAfterMergerHandler(this.processing,[d.x,d.y])},context:this})},clean:function(){var a=this.context;a.clearRect(0,0,this.width,this.height)},setProperty:function(a,b,c,d,e,f,g,h){this.x=a,this.y=b,this.stage.width=this.width=c,this.stage.height=this.height=d,this.imageX=e||0,this.imageY=f||0,this.imageWidth=g||c,this.imageHeight=h||d},fill:function(a,b,c,d,e,f){var g=this.context;this.setStageStyle("background","url("+a+") no-repeat left top"),this.setStageStyle("background-size","100.00000001% 100.00000001%"),g.globalAlpha=1,g.fillStyle="transparent",g.fillRect(b,c,d,e),g.globalAlpha=this.alpha,g.fillStyle=f,g.fillRect(b,c,d,e),this.appendText(this.scratchText),g.globalCompositeOperation="destination-out"},paintImage:function(b,c,d,e,f,g){this.ImageUtil=new a(this.mask(f,g)),this.setProperty(d,e,f,g),this.ImageUtil.drawImage(c,{callback:function(){{var a=this.ImageUtil;this.context}a.pixel({callback:a.blur,context:a,args:[this.blurRadius,!0]}),this.fill(b,this.x,this.y,this.width,this.height,this.context.createPattern(a.stage,"no-repeat")),this.bind()},context:this,args:[]},this.imageX,this.imageY,this.imageWidth,this.imageHeight)},paintColor:function(a,b,c,d,e,f){this.setProperty(c,d,e,f),this.fill(a,c,d,e,f,b),this.bind()}},module.exports=function(a){var b=new d(a),c={setBlurRadius:function(a){return b.setBlurRadius(a),this},setShadowBlur:function(a){return b.setShadowBlur(a),this},setBrushSize:function(a){return b.setBrushSize(a),this},setReady:function(a){return b.setReady(a),this},setBegin:function(a){return b.setBegin(a),this},setProcessing:function(a){return b.setProcessing(a),this},setComplete:function(a){return b.setComplete(a),this},setScratchText:function(a){return b.setScratchText(a),this},clean:function(){return b.clean(),this},setAlpha:function(a){return b.setAlpha(a),this},paintImage:function(a,c,d,e,f,g,h,i,j,k){b.paintImage(a,c,d,e,f,g,h,i,j,k)},paintColor:function(a,c,d,e,f,g){b.paintColor(a,c,d,e,f,g)}};return c}});