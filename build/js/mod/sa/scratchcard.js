/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com */
define(function(require,exports,module){var a=require("mod/sa/image"),b=$.Util,c=function(a){this.ImageUtil=null,this.stage=a,this.context=a.getContext("2d"),this.x=0,this.y=0,this.width=0,this.height=0,this.touched=!1,this.offsetX=this.stage.offsetLeft,this.offsetY=this.stage.offsetTop,this.brushSize=5,this.blurRadius=40,this.complete=null,this.scratchText=null,this.setStageStyle("background-color","transparent")};c.prototype={setStageStyle:function(a,b){$(this.stage).css(a,b)},start:function(a){a.preventDefault();var b=a.data;b.touched=!0},end:function(a){a.preventDefault();var c=a.data;c.touched=!1;for(var d=c.context.getImageData(c.x,c.y,c.width,c.height).data,e=0,f=0,g=0,h=d.length;h>e;e+=4)d[e]&&d[e+1]&&d[e+2]&&d[e+3]?g++:f++;b.execAfterMergerHandler(c.complete,[g,f])},move:function(a){a.preventDefault();var b=a.data;if(b.touched){a.changedTouches&&(a=a.changedTouches[a.changedTouches.length-1]);var c=(a.clientX+document.body.scrollLeft||a.pageX)-b.offsetX||0,d=(a.clientY+document.body.scrollTop||a.pageY)-b.offsetY||0;b.context.beginPath(),b.context.arc(c,d,b.brushSize,0,2*Math.PI),b.context.fill()}},mask:function(a,b){var c=document.createElement("canvas");return c.width=a,c.height=b,c},setBrushSize:function(a){this.brushSize=a},setBlurRadius:function(a){this.blurRadius=a},setComplete:function(a){this.complete=a||null},setScratchText:function(a){this.scratchText=a},appendText:function(a){if(a){var b=this.context;a.text&&(b.font=a.font),a.textAlign&&(b.textAlign=a.textAlign),a.textBaseline&&(b.textBaseline=a.textBaseline),a.color&&(b.fillStyle=a.color),b.fillText(a.text,a.x,a.y)}},paintImage:function(c,d,e,f,g,h){this.ImageUtil=new a(this.mask(g,h)),this.x=e,this.y=f,this.stage.width=this.width=g,this.stage.height=this.height=h,this.ImageUtil.drawImage(d,{callback:function(a,b,d,e,f,g,h){var i=this.ImageUtil;i.pixel({callback:i.blur,context:i,args:[this.blurRadius,!0]}),this.setStageStyle("background-image","url("+c+")"),this.context.fillStyle="transparent",this.context.fillRect(e,f,g,h),this.context.fillStyle=this.context.createPattern(i.stage,"no-repeat"),this.context.fillRect(e,f,g,h),this.appendText(this.scratchText),this.context.globalCompositeOperation="destination-out"},context:this,args:[]},e,f,g,h),"tap"==b.CLICK_EVENT?$(this.stage).on("touchstart","",this,this.start).on("touchmove","",this,this.move).on("touchend","",this,this.end):$(this.stage).on("mousedown","",this,this.start).on("mousemove","",this,this.move).on("mouseup","",this,this.end)},paintColor:function(c,d,e,f,g,h){this.ImageUtil=new a(this.mask(g,h)),this.x=e,this.y=f,this.stage.width=this.width=g,this.stage.height=this.height=h,this.setStageStyle("background-image","url("+c+")"),this.context.fillStyle="transparent",this.context.fillRect(e,f,g,h),this.context.fillStyle=d,this.context.fillRect(e,f,g,h),this.appendText(this.scratchText),this.context.globalCompositeOperation="destination-out","tap"==b.CLICK_EVENT?$(this.stage).on("touchstart","",this,this.start).on("touchmove","",this,this.move).on("touchend","",this,this.end):$(this.stage).on("mousedown","",this,this.start).on("mousemove","",this,this.move).on("mouseup","",this,this.end)}},module.exports=function(a){var b=new c(a),d={setBlurRadius:function(a){return b.setBlurRadius(a),this},setBrushSize:function(a){return b.setBrushSize(a),this},setComplete:function(a){return b.setComplete(a),this},setScratchText:function(a){return b.setScratchText(a),this},paintImage:function(a,c,d,e,f,g){b.paintImage(a,c,d,e,f,g)},paintColor:function(a,c,d,e,f,g){b.paintColor(a,c,d,e,f,g)}};return d}});