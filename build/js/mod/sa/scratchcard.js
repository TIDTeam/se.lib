/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com - Git: https://github.com/zwlijun/se.lib */
define(function(require,exports,module){var a=require("mod/sa/image"),b=$.Util,c=function(a){this.ImageUtil=null,this.stage=a,this.context=a.getContext("2d"),this.x=0,this.y=0,this.width=0,this.height=0,this.imageX=0,this.imageY=0,this.imageWidth=0,this.imageHeight=0,this.touched=!1,this.offsetX=this.stage.offsetLeft,this.offsetY=this.stage.offsetTop,this.brushSize=5,this.blurRadius=40,this.ready=null,this.begin=null,this.processing=null,this.complete=null,this.scratchText=null,this.alpha=1,this.setStageStyle("background-color","transparent")};c.prototype={setStageStyle:function(a,b){$(this.stage).css(a,b)},start:function(a){a.preventDefault(),a.stopPropagation();var c=$(this.stage).offset();this.offsetX=c.left,this.offsetY=c.top;var d=this;d.touched=!0,b.execAfterMergerHandler(d.begin,[])},end:function(a){a.preventDefault(),a.stopPropagation();var c=this;c.touched=!1;for(var d=c.context.getImageData(c.x,c.y,c.width,c.height).data,e=0,f=0,g=0,h=d.length;h>e;e+=4)d[e]&&d[e+1]&&d[e+2]&&d[e+3]?g++:f++;b.execAfterMergerHandler(c.complete,[g,f])},move:function(a){a.preventDefault(),a.stopPropagation();var c=this;if(c.touched){a.changedTouches&&(a=a.changedTouches[a.changedTouches.length-1]);var d=(a.clientX+document.body.scrollLeft||a.pageX)-c.offsetX||0,e=(a.clientY+document.body.scrollTop||a.pageY)-c.offsetY||0;console.info("e.clientX: "+a.clientX),console.info("e.clientY: "+a.clientY),console.info("e.pageX: "+a.pageX),console.info("e.pageY: "+a.pageY),console.info("data.offsetX: "+c.offsetX),console.info("data.offsetY: "+c.offsetY),console.info("body.scrollLeft: "+document.body.scrollLeft),console.info("body.scrollTop: "+document.body.scrollTop),b.execAfterMergerHandler(c.processing,[d,e]),c.context.beginPath(),c.context.arc(d,e,c.brushSize,0,2*Math.PI),c.context.fill()}},mask:function(a,b){var c=document.createElement("canvas");return c.width=a,c.height=b,c},setAlpha:function(a){this.alpha=a},setBrushSize:function(a){this.brushSize=a},setBlurRadius:function(a){this.blurRadius=a},setReady:function(a){this.ready=a},setBegin:function(a){this.begin=a},setProcessing:function(a){this.processing=a},setComplete:function(a){this.complete=a||null},setScratchText:function(a){this.scratchText=a},appendText:function(a){if(a){var b=this.context;a.text&&(b.font=a.font),a.textAlign&&(b.textAlign=a.textAlign),a.textBaseline&&(b.textBaseline=a.textBaseline),a.color&&(b.fillStyle=a.color),b.fillText(a.text,a.x,a.y)}},bind:function(){var a=this.stage,c=this;b.execAfterMergerHandler(c.ready,[]),"tap"==b.CLICK_EVENT?(a.addEventListener("touchstart",function(a){c.start(a)},!1),a.addEventListener("touchmove",function(a){c.move(a)},!1),a.addEventListener("touchend",function(a){c.end(a)},!1)):(a.addEventListener("mousedown",function(a){c.start(a)},!1),a.addEventListener("mousemove",function(a){c.move(a)},!1),a.addEventListener("mouseup",function(a){c.end(a)},!1))},clean:function(){var a=this.context;a.clearRect(0,0,this.width,this.height)},setProperty:function(a,b,c,d,e,f,g,h){this.x=a,this.y=b,this.stage.width=this.width=c,this.stage.height=this.height=d,this.imageX=e||0,this.imageY=f||0,this.imageWidth=g||c,this.imageHeight=h||d},fill:function(a,b,c,d,e,f){var g=this.context;this.setStageStyle("background","url("+a+") no-repeat left top"),this.setStageStyle("background-size","100.00000001% 100.00000001%"),g.globalAlpha=1,g.fillStyle="transparent",g.fillRect(b,c,d,e),g.globalAlpha=this.alpha,g.fillStyle=f,g.fillRect(b,c,d,e),this.appendText(this.scratchText),g.globalCompositeOperation="destination-out"},paintImage:function(b,c,d,e,f,g){this.ImageUtil=new a(this.mask(f,g)),this.setProperty(d,e,f,g),this.ImageUtil.drawImage(c,{callback:function(){{var a=this.ImageUtil;this.context}a.pixel({callback:a.blur,context:a,args:[this.blurRadius,!0]}),this.fill(b,this.x,this.y,this.width,this.height,this.context.createPattern(a.stage,"no-repeat")),this.bind()},context:this,args:[]},this.imageX,this.imageY,this.imageWidth,this.imageHeight)},paintColor:function(a,b,c,d,e,f){this.setProperty(c,d,e,f),this.fill(a,c,d,e,f,b),this.bind()}},module.exports=function(a){var b=new c(a),d={setBlurRadius:function(a){return b.setBlurRadius(a),this},setBrushSize:function(a){return b.setBrushSize(a),this},setReady:function(a){return b.setReady(a),this},setBegin:function(a){return b.setBegin(a),this},setProcessing:function(a){return b.setProcessing(a),this},setComplete:function(a){return b.setComplete(a),this},setScratchText:function(a){return b.setScratchText(a),this},clean:function(){return b.clean(),this},setAlpha:function(a){return b.setAlpha(a),this},paintImage:function(a,c,d,e,f,g,h,i,j,k){b.paintImage(a,c,d,e,f,g,h,i,j,k)},paintColor:function(a,c,d,e,f,g){b.paintColor(a,c,d,e,f,g)}};return d}});