/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com */
define(function(require,exports,module){var a=$.Listener=require("mod/se/listener"),b=$.StringUtil=require("mod/se/stringutil"),c=$.Request=require("mod/se/request"),d={CNID:function(a){function b(a){var b=0,f=0,g=0;18==a.length&&(a=a.substring(0,17));for(var h=0;17>h;h++)g=a.substring(h,h+1),e[h]=1*g;for(var i=0;17>i;i++)f+=c[i]*e[i];return b=f%11,d[b]}var c=[7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2,1],d=[1,0,"X",9,8,7,6,5,4,3,2],e=[],f=null;return 15!=a.length&&18!=a.length?!1:(15==a.length&&(f=a.substring(0,6),f+="19",f+=a.substring(6,15),f+=b(f),a=f),b(a)==a.substring(17,18))},HKID:function(a){for(var b={A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,I:9,J:10,K:11,L:12,M:13,N:14,O:15,P:16,Q:17,R:18,S:19,T:20,U:21,V:22,W:23,X:24,Y:25,Z:26},c=a.substring(0,7),d=c.split(""),e=null,f=0,g=0,h=1*a.substring(8,9),i=0,j=8;7>i;i++,j--)e=b[d[i]]||d[i],f+=e*j;return g=f%11==0?0:11-f%11,h==g}},e=function(b,c){this.name=b,this.prefix=c||"",this.form=$(this.prefix+'form[name="'+this.name+'"]'),this.listner=new a({ontips:null,oncustomcheck:null,ondone:null,onbefore:null,onbeforecheck:null,onsubmit:null}),this.bindSubmit()};e.prototype={updateForm:function(){this.form=$(this.prefix+'form[name="'+this.name+'"]')},exec:function(a,b){return this.listner.exec(a,b)},set:function(a,b){this.listner.set(a,b)},remove:function(a){this.listner.remove(a)},get:function(a){return this.listner.get(a)},clear:function(){this.listner.clear()},doCheck:function(){for(var a=this.form,e=a.prop("elements"),f=e.length,g=null,h=null,i=null,j=0,k=null,l=null,m=null,n=null,o=null,p=!1,q=!0,r=null,s=0,t=0,u=null,v=null,w=null,x={},y=0;f>y;y++)if(g=$(e[y]),h=g.attr("name"),h&&(i=b.trim(g.val()),p=g.prop("disabled")||"1"==g.attr("data-filter"),w=g.attr("placeholder")||g.attr("data-placeholder")||"",!0!==p)){if(w&&w==i&&(i=""),j=b.length(i),required=g.prop("required")||"1"==g.attr("data-required"),k=g.attr("pattern")||g.attr("data-pattern"),l=g.attr("data-empty")||"",m=g.attr("data-invalid")||"",n=g.attr("data-different")||"",encode="1"==g.attr("data-encode"),q="1"==g.attr("data-xss"),s=Number(g.attr("data-lbound")||0),t=Number(g.attr("data-ubound")||0),r=g.attr("data-compare"),u=g.attr("data-refer"),v=g.attr("data-custom"),required&&""==i)return this.exec("tips",[g,l]),null;if(""!=i&&k){var z=new RegExp(k);if(!z.test(i))return this.exec("tips",[g,m]),null;k=null,z=null}if(s>0||t>0){if(s>0&&s>j)return this.exec("tips",[g,m]),null;if(t>0&&j>t)return this.exec("tips",[g,m]),null}if(v&&this.get("customcheck")&&null!=(o=this.exec("customcheck",[d,functionName,g])))return this.exec("tips",[g,o]),null;if(r){var A=b.trim(e[r].value);if(i!=A)return this.exec("tips",[g,n]),null}q&&(i=c.filterScript(i)),encode&&(i=encodeURIComponent(i)),x[h]=i,u&&(g=$(u)).length>0&&(x[h]=b.trim(g.val()))}return this.exec("done",[{action:a.attr("action"),method:a.attr("method"),data:x}]),!0},check:function(){var a=this.get("beforecheck");this.exec("before",[]),(null==a||null!=a&&!0!==a.returnValue||null!=a&&this.exe("beforecheck",[]))&&this.doCheck()},submitHandler:function(a){var b=a.data;b&&b.exec&&b.exec("submit",[a]),b=null},bindSubmit:function(){var a=this.form;a.length>0&&(a.attr("data-form",this.name),a.on("submit",a,this.submitHandler))}};var f={};module.exports={getInstance:function(a,b){var c=f[a]||new e(a,b);c.updateForm();var d={name:c.name,prefix:c.prefix,form:c.form,set:function(a,b){c.set(a,b)},remove:function(a){c.remove(a)},get:function(a){return c.get(a)},exec:function(a,b){return c.exec(a,b)},clear:function(){c.clear()},check:function(){c.check()}};return f[a]=c,d}}});