/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com - Git: https://github.com/zwlijun/se.lib */
define(function(require,exports,module){require("lib/extra/iscroll5/iscroll-probe"),require("mod/se/raf");var a=require("mod/se/listener"),b=($.Util=require("mod/se/util"),require("mod/sa/lightanimation")),c=require("mod/sa/scenetransitions"),d=window.IScroll,e={DRAWCARD:"drawcard",SCREEN:"screen",WATERFALL:"waterfall"},f={VERTICAL:"vertical",HORIZONTAL:"horizontal"},g={ONCE:"once",EVERYTIME:"everytime"},h=function(a,module,b,c){this.app=a,this.module=module,this.widget=b,this.source=c,this.effect=this.createAnimate(c)};h.prototype={createAnimate:function(a){var c=b.newInstance(this.widget,a);return c.set("complete",{callback:function(){this.app.exec("widget",[this.module,this.widget])},context:this}),c},next:function(){this.effect.play()},restore:function(){this.effect.reset()}};var i=function(b,c,d,h){var i=$("#"+b),j=$("#"+c),k=$("#"+d),l=$("#"+h);if(!b||!c||1!=i.length||1!=j.length)throw new Error("APP is not valid, appId = "+b+", viewId = "+c);if(d&&1!=k.length)throw new Error("APP's `header` is not found("+d+")");if(h&&1!=l.length)throw new Error("APP's `footer` is not found("+h+")");1!=k.length&&(k=null),1!=l.length&&(l=null),this.root=$("html"),this.appId=b,this.viewId=c,this.headerId=d,this.footerId=h,this.app=i,this.view=j,this.header=k,this.footer=l,this.modules=null,this.moduleSize=0,this.widgets={},this.viewport=null,this.mode=e.SCREEN,this.scroll=f.VERTICAL,this.widgetMode=g.ONCE,this.fps=0,this.moduleSnap=[],this.snapRangeOffset=20,this.snapSpeed=400,this.sceneDeg=28,this.sceneDuration=.28,this.scenePerspective="300px",this.listener=new a({oninit:null,onbefore:null,onbegin:null,onscrolling:null,onend:null,onwidget:null,onresize:null,onorientationchange:null,onenterframe:null})};i.prototype={exec:function(a,b){return this.listener.exec(a,b)},set:function(a,b){this.listener.set(a,b)},remove:function(a){this.listener.remove(a)},get:function(a){return this.listener.get(a)},clear:function(){this.listener.clear()},setFPS:function(a){this.fps=a},calcModulePanelOffset:function(){var a=$(".webapp-modules"),b=a.offset(),c=this.view.offset();a.css({width:(b.width||c.width)+"px",height:(b.height||c.height)+"px"}),a.attr("data-x",b.left).attr("data-y",b.top).attr("data-width",b.width||c.width).attr("data-height",b.height||c.height)},calcModuleOffset:function(){var a=this,b=this.header?this.header.offset():{width:0,height:0};$.each(this.modules,function(c,module){var d=$(module),e=d.offset();d.attr("data-index",c).attr("data-x",e.left).attr("data-y",e.top).attr("data-width",e.width).attr("data-height",e.height),a.moduleSnap.push({index:c,x:e.left,y:e.top-b.height,width:e.width,height:e.height}),a.queryModuleWidget(c,d)})},calcViewportOffset:function(){var a=window.innerWidth,b=window.innerHeight,c=this.header?this.header.offset():{width:0,height:0},d=this.footer?this.footer.offset():{width:0,height:0};b=b-c.height-d.height,this.view.css({width:a+"px",height:b+"px"});var e=this.view.offset();this.view.attr("data-x",e.left).attr("data-y",e.top).attr("data-width",e.width).attr("data-height",e.height)},adjusted:function(){var a=window.innerWidth,b=window.innerHeight,c=this.header?this.header.offset():{width:0,height:0},d=this.footer?this.footer.offset():{width:0,height:0};b=b-c.height-d.height,this.modules.css({width:a+"px",height:b+"px"}),this.calcModuleOffset(),this.calcModulePanelOffset()},preventTouchMove:function(){$(document).on("touchmove",function(a){a.preventDefault()})},getCurrentModuleIndex:function(){var a=this,b=a.viewport.currentPage,c=0;return b&&(c=a.scroll==f.VERTICAL?b.pageY:b.pageX),c},getModuleSnapRange:function(){for(var a=this,b=a.viewport,c=Math.abs(b.x),d=Math.abs(b.y),e=[],g=a.moduleSnap,h=g.length,i=null,j=a.view.offset(),k=c+j.width,l=d+j.height,m=a.snapRangeOffset,n=0;h>n;n++)i=g[n],a.scroll==f.VERTICAL?i.y+m>=d&&i.y+m<=l&&e.push(i):i.x+m>=c&&i.x+m<=k&&e.push(i);return e},queryModuleWidget:function(a,module){var b=this,c=null,d=String(a);b.widgets[d]||(c=module.find("[data-widget]"),b.widgets[d]=[],$.each(c,function(a,c){var e=$(c),f=e.attr("data-widget");b.widgets[d].push(new h(b,module,e,f))}))},showModuleWidget:function(a){var b=this,c=b.widgets[String(a)]||[],module=$(b.modules[a]),d=module.attr("data-setted");if(g.EVERYTIME==b.widgetMode||"1"!=d){for(var e=0,f=c.length;f>e;e++)!function(a){a.next()}(c[e]);module.attr("data-setted","1")}},restoreModuleWidget:function(a){var b=this,c=b.widgets[String(a)]||[];if(g.EVERYTIME==b.widgetMode)for(var d=0,e=c.length;e>d;d++)c[d].restore()},displayViewportWidget:function(){for(var a=this.getModuleSnapRange(),b=a.length,c=0;b>c;c++)this.showModuleWidget(a[c].index)},initViewport:function(a){var b=this,c={mouseWheel:!0,scrollbars:!1,probeType:3,click:!0,scrollX:f.HORIZONTAL==b.scroll,scrollY:f.VERTICAL==b.scroll};b.viewport=new d(this.view[0],$.extend(c,a)),b.preventTouchMove(),b.viewport.refresh()},createWaterfallViewport:function(){var a=this;a.calcModuleOffset(),a.calcModulePanelOffset(),a.initViewport({probeType:1}),a.viewport.on("beforeScrollStart",function(){a.exec("before",[a.viewport])}),a.viewport.on("scrollStart",function(){a.exec("start",[a.viewport])}),a.viewport.on("scroll",function(){a.exec("scrolling",[a.viewport])}),a.viewport.on("scrollEnd",function(){a.displayViewportWidget(),a.exec("end",[a.viewport])})},createSingleScreenViewport:function(){var a=this;a.adjusted(),a.initViewport({momentum:!1,probeType:1,snap:"section",snapSpeed:a.snapSpeed,mouseWheel:!1}),a.viewport.on("beforeScrollStart",function(){a.exec("before",[a.viewport])}),a.viewport.on("scrollStart",function(){a.restoreModuleWidget(a.getCurrentModuleIndex()),a.exec("start",[a.viewport])}),a.viewport.on("scroll",function(){a.exec("scrolling",[a.viewport])}),a.viewport.on("scrollEnd",function(){a.showModuleWidget(a.getCurrentModuleIndex()),a.exec("end",[a.viewport])})},createDrawCardViewport:function(){var a=this,b=null;a.adjusted(),a.initViewport({momentum:!1,probeType:3,snap:"section",snapSpeed:a.snapSpeed,mouseWheel:!1}),b=c.newInstance("section",TransitionEffect.ROTATE,a.scroll),b.setDeg(a.sceneDeg),b.setDuration(a.sceneDuration),b.setPerspective(a.scenePerspective),b.set("start",{callback:function(b,c,d,e,f){a.restoreModuleWidget(f),this.exec("start",[this.viewport])},context:a}),b.set("drawing",{callback:function(){this.exec("scrolling",[this.viewport])},context:a}),b.set("complete",{callback:function(b,c){a.showModuleWidget(c),this.exec("end",[this.viewport])},context:a})},createViewport:function(){var a=this;switch(a.calcViewportOffset(),a.mode){case e.WATERFALL:a.createWaterfallViewport();break;case e.DRAWCARD:a.createDrawCardViewport();break;case e.SCREEN:a.createSingleScreenViewport();break;default:throw new Error("Unkonwn View Mode("+a.mode+")")}},resize:function(){var a=this;switch(a.calcViewportOffset(),a.mode){case e.WATERFALL:a.calcModuleOffset(),a.calcModulePanelOffset();break;case e.DRAWCARD:a.adjusted();break;case e.SCREEN:a.adjusted();break;default:throw new Error("Unkonwn View Mode("+a.mode+")")}a.viewport.refresh()},enterframe:function(){var a=this,b=0,c=0;requestAnimationFrame(function(){c=(new Date).getTime(),(a.fps<=0||c-b>1e3/a.fps)&&(b=c,a.exec("enterframe",[]),requestAnimationFrame(arguments.callee))})},setAppMode:function(){var a=this.root;a.removeClass(),a.addClass("webapp mode-"+this.mode)},init:function(){var a=this;a.modules=$(".webapp-modules section"),a.moduleSize=a.modules.length,a.mode=a.app.attr("data-mode")||e.SCREEN,a.scroll=a.app.attr("data-scroll")||f.VERTICAL,a.widgetMode=a.app.attr("data-widget-mode")||g.ONCE,a.setAppMode(),a.createViewport(),a.enterframe(),$(window).on("resize","",a,function(a){var b=a.data;b.resize(),b.exec("resize",[])}).on("orientationchange","",a,function(a){var b=a.data;b.resize(),b.exec("orientationchange",[])})}};var j={newInstance:function(a,b,c,d){var h=new i(a,b,c,d);return{viewport:null,mode:e.SCREEN,scroll:f.VERTICAL,widgetMode:g.ONCE,create:function(){h.init(),this.viewport=h.viewport,this.mode=h.mode,this.scroll=h.scroll,this.widgetMode=h.widgetMode,h.exec("init",[])},set:function(a,b){return h.set(a,b),this},setFPS:function(a){return h.setFPS(a),this},setSnapSpeed:function(a){return h.snapSpeed=a,this},setSnapRangeOffset:function(a){return h.snapRangeOffset=a,this},getCurrentModuleIndex:function(){return h.getCurrentModuleIndex()},getModuleSnapRange:function(){return h.getModuleSnapRange()},displayViewportWidget:function(){h.displayViewportWidget()},showModuleWidget:function(a){h.showModuleWidget(a)},restoreModuleWidget:function(a){h.restoreModuleWidget(a)},refresh:function(){this.viewport.refresh()},scrollTo:function(a,b,c,d){this.viewport.scrollTo(a,b,c,IScroll.utils.ease[d])},scrollBy:function(a,b,c,d){this.viewport.scrollBy(a,b,c,IScroll.utils.ease[d])},scrollToElement:function(a,b,c,d,e){this.viewport.scrollToElement(a,b,c,d,IScroll.utils.ease[e])},goToPage:function(a,b,c,d){this.viewport.goToPage(a,b,c,IScroll.utils.ease[d])},next:function(){this.viewport.next()},prev:function(){this.viewport.prev()},setSceneDeg:function(a){return h.sceneDeg=a,this},setSceneDuration:function(a){return h.sceneDuration=a,this},setScenePerspective:function(a){return h.scenePerspective=a,this}}}};module.exports=j});