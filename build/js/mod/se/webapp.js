/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com - Git: https://github.com/zwlijun/se.lib */
define(function(require,exports,module){require("lib/extra/iscroll5/iscroll-probe"),require("mod/se/raf");var a=require("mod/se/listener"),b=$.Util=require("mod/se/util"),c=require("mod/sa/lightanimation"),d=require("mod/sa/scenetransitions"),e=window.IScroll,f={DRAWCARD:"drawcard",SCREEN:"screen"},g={VERTICAL:"vertical",HORIZONTAL:"horizontal"},h=function(a,module,b,c){this.app=a,this.module=module,this.widget=b,this.source=c,this.effect=this.createAnimate(c)};h.prototype={createAnimate:function(a){var b=c.newInstance(this.widget,a);return b.set("complete",{callback:function(){this.app.exec("widget",[this.module,this.widget])},context:this}),b},next:function(){this.effect.play()}};var i=function(b,c,d,e){var h=$("#"+b),i=$("#"+c),j=$("#"+d),k=$("#"+e);if(!b||!c||1!=h.length||1!=i.length)throw new Error("APP is not valid, appId = "+b+", viewId = "+c);if(d&&1!=j.length)throw new Error("APP's `header` is not found("+d+")");if(e&&1!=k.length)throw new Error("APP's `footer` is not found("+e+")");1!=j.length&&(j=null),1!=k.length&&(k=null),this.root=$("html"),this.appId=b,this.viewId=c,this.headerId=d,this.footerId=e,this.app=h,this.view=i,this.header=j,this.footer=k,this.scroller=null,this.modules=null,this.innerboxes=null,this.widgets={},this.viewport=null,this.mode=f.SCREEN,this.scroll=g.VERTICAL,this.device={width:320,height:480,ratioWidth:"100%",ratioHeight:"100%"},this.fps=0,this.snapSpeed=400,this.sceneDeg=28,this.sceneDuration=.28,this.scenePerspective="300px",this.listener=new a({oninit:null,onbefore:null,onbegin:null,onscrolling:null,onend:null,onwidget:null,onresize:null,onorientationchange:null,onenterframe:null})};i.prototype={exec:function(a,b){return this.listener.exec(a,b)},set:function(a,b){this.listener.set(a,b)},remove:function(a){this.listener.remove(a)},get:function(a){return this.listener.get(a)},clear:function(){this.listener.clear()},setFPS:function(a){this.fps=a},layout:function(a,c,d,e){$.each(a,function(a,f){var g=$(f);g.css({width:((c.width||d.width)+"px").replace("%px","%"),height:((c.height||d.height)+"px").replace("%px","%")}),offset=g.offset(),g.attr("data-index",a).attr("data-x",offset.left).attr("data-y",offset.top).attr("data-width",offset.width).attr("data-height",offset.height),b.execAfterMergerHandler(e,[a,g]),g=null})},update:function(){var a=this,b=window.innerWidth,c=window.innerHeight,d=this.header?this.header.offset():{width:0,height:0},e=this.footer?this.footer.offset():{width:0,height:0};c=c-d.height-e.height;var f={width:b,height:c};a.setAppDeviceSize(),a.layout(a.view,f,f,null),a.layout(a.modules,f,f,{callback:function(a,module){this.queryModuleWidget(a,module)},context:a}),a.layout(a.scroller,a.scroller.offset(),f,null),a.layout(a.innerboxes,{width:a.device.ratioWidth,height:a.device.ratioHeight},f,null)},preventTouchMove:function(){$(document).on("touchmove",function(a){a.preventDefault()})},getCurrentModuleIndex:function(){var a=this,b=a.viewport.currentPage,c=0;return b&&(c=a.scroll==g.VERTICAL?b.pageY:b.pageX),c},queryModuleWidget:function(a,module){var b=this,c=null,d=String(a);b.widgets[d]||(c=module.find("[data-widget]"),b.widgets[d]=[],$.each(c,function(a,c){var e=$(c),f=e.attr("data-widget");b.widgets[d].push(new h(b,module,e,f))}))},showModuleWidget:function(a){var b=this,c=b.widgets[String(a)]||[],module=$(b.modules[a]),d=module.attr("data-setted");if("1"!=d){for(var e=0,f=c.length;f>e;e++)!function(a){a.next()}(c[e]);module.attr("data-setted","1")}},initViewport:function(a){var b=this,c={mouseWheel:!0,scrollbars:!1,probeType:3,click:!0,scrollX:g.HORIZONTAL==b.scroll,scrollY:g.VERTICAL==b.scroll};b.viewport=new e(this.view[0],$.extend(c,a)),console.info(b.viewport.options),b.viewport.refresh()},createSingleScreenViewport:function(){var a=this;a.initViewport({momentum:!1,probeType:1,snap:"section",snapSpeed:a.snapSpeed,mouseWheel:!1}),a.viewport.on("beforeScrollStart",function(){a.exec("before",[a.viewport,a.getCurrentModuleIndex()])}),a.viewport.on("scrollStart",function(){a.exec("start",[a.viewport,a.getCurrentModuleIndex()])}),a.viewport.on("scroll",function(){a.exec("scrolling",[a.viewport,a.getCurrentModuleIndex()])}),a.viewport.on("scrollEnd",function(){a.showModuleWidget(a.getCurrentModuleIndex()),a.exec("end",[a.viewport,a.getCurrentModuleIndex()])})},createDrawCardViewport:function(){var a=this,b=null;a.initViewport({momentum:!1,probeType:3,snap:"section",snapSpeed:a.snapSpeed,mouseWheel:!1}),b=d.newInstance("section",TransitionEffect.ROTATE,a.scroll),b.setDeg(a.sceneDeg),b.setDuration(a.sceneDuration),b.setPerspective(a.scenePerspective),b.set("start",{callback:function(a,b,c,d,e){this.exec("start",[this.viewport,e])},context:a}),b.set("drawing",{callback:function(a,b,c,d,e){this.exec("scrolling",[this.viewport,e])},context:a}),b.set("complete",{callback:function(b,c){a.showModuleWidget(c),this.exec("end",[this.viewport,c])},context:a})},createViewport:function(){var a=this;switch(a.update(),a.mode){case f.DRAWCARD:a.createDrawCardViewport();break;case f.SCREEN:a.createSingleScreenViewport();break;default:throw new Error("Unkonwn View Mode("+a.mode+")")}},resize:function(){var a=this;switch(a.mode){case f.DRAWCARD:case f.SCREEN:a.update();break;default:throw new Error("Unkonwn View Mode("+a.mode+")")}a.viewport.refresh()},enterframe:function(){var a=this,b=0,c=0;requestAnimationFrame(function(){c=(new Date).getTime(),(a.fps<=0||c-b>1e3/a.fps)&&(b=c,a.exec("enterframe",[]),requestAnimationFrame(arguments.callee))})},setAppDeviceSize:function(){var a=this,b=a.app.attr("data-device")||"",c=b.split("/"),d=c[0]||"device-width",e=c[1]||"device-height",f=window.screen.width,g=window.screen.height;d=isNaN(Number(d))?"device-width":Number(d),e=isNaN(Number(e))?"device-height":Number(e),"device-width"==d&&(d=f),"device-height"==e&&(e=g),d=Math.min(Math.max(d,200),1e4),e=Math.min(Math.max(e,223),1e4),a.device={width:d,height:e,ratioWidth:"100%",ratioHeight:f*e/d/g*100+"%"}},init:function(){var a=this;a.scroller=$(".webapp-modules"),a.modules=$(".webapp-modules>section"),a.innerboxes=$(".webapp-modules>section>.innerbox"),a.mode=a.app.attr("data-mode")||f.SCREEN,a.scroll=a.app.attr("data-scroll")||g.VERTICAL,a.createViewport(),a.enterframe(),$(window).on("resize","",a,function(a){var b=a.data;b.resize(),b.exec("resize",[])}).on("orientationchange","",a,function(a){var b=a.data;b.resize(),b.exec("orientationchange",[])})}};var j={newInstance:function(a,b,c,d){var e=new i(a,b,c,d);return{viewport:null,mode:f.SCREEN,scroll:g.VERTICAL,create:function(){e.init(),this.viewport=e.viewport,this.mode=e.mode,this.scroll=e.scroll,e.exec("init",[])},set:function(a,b){return e.set(a,b),this},setFPS:function(a){return e.setFPS(a),this},setSnapSpeed:function(a){return e.snapSpeed=a,this},showModuleWidget:function(a){e.showModuleWidget(a)},refresh:function(){this.viewport.refresh()},scrollTo:function(a,b,c,d){this.viewport.scrollTo(a,b,c,IScroll.utils.ease[d])},scrollBy:function(a,b,c,d){this.viewport.scrollBy(a,b,c,IScroll.utils.ease[d])},scrollToElement:function(a,b,c,d,e){this.viewport.scrollToElement(a,b,c,d,IScroll.utils.ease[e])},goToPage:function(a,b,c,d){this.viewport.goToPage(a,b,c,IScroll.utils.ease[d])},next:function(){this.viewport.next()},prev:function(){this.viewport.prev()},setSceneDeg:function(a){return e.sceneDeg=a,this},setSceneDuration:function(a){return e.sceneDuration=a,this},setScenePerspective:function(a){return e.scenePerspective=a,this}}}};module.exports=j});