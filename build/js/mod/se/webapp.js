/*! Copyright (c) SESHENGHUO.COM - Author: LIJUN - Email: zwlijun@gmail.com - Git: https://github.com/zwlijun/se.lib */
define(function(require,exports,module){require("lib/extra/iscroll5/iscroll"),require("mod/se/raf");var a=require("mod/se/listener"),b=($.Util=require("mod/se/util"),require("mod/sa/lightanimation")),c=window.IScroll,d={DRAWCARD:"drawcard",WATERFALL:"waterfall"},e={VERTICAL:"vertical",HORIZONTAL:"horizontal"},f={ONCE:"once",EVERYTIME:"everytime"},g=function(a,module,b,c){this.app=a,this.module=module,this.widget=b,this.source=c,this.effect=this.createAnimate(c)};g.prototype={createAnimate:function(a){var c=b.newInstance(this.widget,a);return c.set("complete",{callback:function(){this.app.exec("widget",[this.module,this.widget])},context:this}),c},next:function(){this.effect.play()},restore:function(){this.effect.reset()}};var h=function(b,c,g,h){var i=$("#"+b),j=$("#"+c),k=$("#"+g),l=$("#"+h);if(!b||!c||1!=i.length||1!=j.length)throw new Error("APP is not valid, appId = "+b+", viewId = "+c);if(g&&1!=k.length)throw new Error("APP's `header` is not found("+g+")");if(h&&1!=l.length)throw new Error("APP's `footer` is not found("+h+")");1!=k.length&&(k=null),1!=l.length&&(l=null),this.appId=b,this.viewId=c,this.headerId=g,this.footerId=h,this.app=i,this.view=j,this.header=k,this.footer=l,this.modules=null,this.moduleSize=0,this.widgets={},this.viewport=null,this.mode=d.WATERFALL,this.scroll=e.VERTICAL,this.widgetMode=f.ONCE,this.fps=0,this.moduleSnap=[],this.snapRangeOffset=20,this.snapSpeed=400,this.listener=new a({oninit:null,onbefore:null,onbegin:null,onend:null,onwidget:null,onenterframe:null})};h.prototype={exec:function(a,b){return this.listener.exec(a,b)},set:function(a,b){this.listener.set(a,b)},remove:function(a){this.listener.remove(a)},get:function(a){return this.listener.get(a)},clear:function(){this.listener.clear()},setFPS:function(a){this.fps=a},calcModulePanelOffset:function(){var a=$(".webapp-modules"),b=a.offset();a.css({width:b.width+"px",height:b.height+"px"}),a.attr("data-x",b.left).attr("data-y",b.top).attr("data-width",b.width).attr("data-height",b.height)},calcModuleOffset:function(){var a=this,b=this.header?this.header.offset():{width:0,height:0};$.each(this.modules,function(c,module){var d=$(module),e=d.offset();d.attr("data-index",c).attr("data-x",e.left).attr("data-y",e.top).attr("data-width",e.width).attr("data-height",e.height),a.moduleSnap.push({index:c,x:e.left,y:e.top-b.height,width:e.width,height:e.height}),a.queryModuleWidget(c,d)})},calcViewportOffset:function(){var a=window.innerWidth,b=window.innerHeight,c=this.header?this.header.offset():{width:0,height:0},d=this.footer?this.footer.offset():{width:0,height:0};b=b-c.height-d.height,this.view.css({width:a+"px",height:b+"px"})},adjusted:function(){var a=window.innerWidth,b=window.innerHeight,c=this.header?this.header.offset():{width:0,height:0},d=this.footer?this.footer.offset():{width:0,height:0};b=b-c.height-d.height,this.modules.css({width:a+"px",height:b+"px"}),this.calcModuleOffset(),this.calcModulePanelOffset()},preventTouchMove:function(){$(document).on("touchmove",function(a){a.preventDefault()})},getCurrentModuleIndex:function(){var a=this,b=a.viewport.currentPage,c=0;return b&&(c=a.scroll==e.VERTICAL?b.pageY:b.pageX),c},getModuleSnapRange:function(){for(var a=this,b=a.viewport,c=Math.abs(b.x),d=Math.abs(b.y),f=[],g=a.moduleSnap,h=g.length,i=null,j=a.view.offset(),k=c+j.width,l=d+j.height,m=a.snapRangeOffset,n=0;h>n;n++)i=g[n],a.scroll==e.VERTICAL?i.y+m>=d&&i.y+m<=l&&f.push(i):i.x+m>=c&&i.x+m<=k&&f.push(i);return f},queryModuleWidget:function(a,module){var b=this,c=null,d=String(a);b.widgets[d]||(c=module.find("[data-widget]"),b.widgets[d]=[],$.each(c,function(a,c){var e=$(c),f=e.attr("data-widget");b.widgets[d].push(new g(b,module,e,f))}))},showModuleWidget:function(a){var b=this,c=b.widgets[String(a)]||[],module=$(b.modules[a]),d=module.attr("data-setted");if(f.EVERYTIME==b.widgetMode||"1"!=d){for(var e=0,g=c.length;g>e;e++)!function(a){a.next()}(c[e]);module.attr("data-setted","1")}},restoreModuleWidget:function(a){var b=this,c=b.widgets[String(a)]||[];if(f.EVERYTIME==b.widgetMode)for(var d=0,e=c.length;e>d;d++)c[d].restore()},displayViewportWidget:function(){for(var a=this.getModuleSnapRange(),b=a.length,c=0;b>c;c++)this.showModuleWidget(a[c].index)},initViewport:function(a){var b=this,d={mouseWheel:!0,scrollbars:!1,click:!0,scrollX:e.HORIZONTAL==b.scroll,scrollY:e.VERTICAL==b.scroll};b.viewport=new c(this.view[0],$.extend(d,a)),b.viewport.refresh()},createWaterfallViewport:function(){var a=this;a.calcModuleOffset(),a.calcModulePanelOffset(),a.initViewport({}),a.viewport.on("beforeScrollStart",function(){a.exec("before",[a.viewport])}),a.viewport.on("scrollStart",function(){a.exec("start",[a.viewport])}),a.viewport.on("scrollEnd",function(){a.displayViewportWidget(),a.exec("end",[a.viewport])})},createDrawCardViewport:function(){var a=this;a.adjusted(),a.initViewport({momentum:!1,snap:"section",snapSpeed:a.snapSpeed,mouseWheel:!1}),a.viewport.on("beforeScrollStart",function(){a.exec("before",[a.viewport])}),a.viewport.on("scrollStart",function(){a.restoreModuleWidget(a.getCurrentModuleIndex()),a.exec("start",[a.viewport])}),a.viewport.on("scroll",function(){a.exec("scroll",[a.viewport])}),a.viewport.on("scrollEnd",function(){a.showModuleWidget(a.getCurrentModuleIndex()),a.exec("end",[a.viewport])})},createViewport:function(){var a=this;switch(a.calcViewportOffset(),a.mode){case d.WATERFALL:a.createWaterfallViewport();break;case d.DRAWCARD:a.createDrawCardViewport();break;default:throw new Error("Unkonwn View Mode("+a.mode+")")}},enterframe:function(){var a=this,b=0,c=0;requestAnimationFrame(function(){c=(new Date).getTime(),(a.fps<=0||c-b>1e3/a.fps)&&(b=c,a.exec("enterframe",[]),requestAnimationFrame(arguments.callee))})},init:function(){var a=this;a.modules=$(".webapp-modules section"),a.moduleSize=a.modules.length,a.mode=a.app.attr("data-mode")||d.WATERFALL,a.scroll=a.app.attr("data-scroll")||e.VERTICAL,a.widgetMode=a.app.attr("data-widget-mode")||f.ONCE,a.createViewport(),a.enterframe()}};var i={newInstance:function(a,b,c,g){var i=new h(a,b,c,g);return{viewport:null,mode:d.DRAWCARD,scroll:e.VERTICAL,widgetMode:f.ONCE,create:function(){i.init(),this.viewport=i.viewport,this.mode=i.mode,this.scroll=i.scroll,this.widgetMode=i.widgetMode,i.exec("init",[])},set:function(a,b){return i.set(a,b),this},setFPS:function(a){return i.setFPS(a),this},setSnapSpeed:function(a){return i.snapSpeed=a,this},setSnapRangeOffset:function(a){return i.snapRangeOffset=a,this},getCurrentModuleIndex:function(){return i.getCurrentModuleIndex()},getModuleSnapRange:function(){return i.getModuleSnapRange()},displayViewportWidget:function(){i.displayViewportWidget()},showModuleWidget:function(a){i.showModuleWidget(a)},restoreModuleWidget:function(a){i.restoreModuleWidget(a)},refresh:function(){this.viewport.refresh()},scrollTo:function(a,b,c,d){this.viewport.scrollTo(a,b,c,IScroll.utils.ease[d])},scrollBy:function(a,b,c,d){this.viewport.scrollBy(a,b,c,IScroll.utils.ease[d])},scrollToElement:function(a,b,c,d,e){this.viewport.scrollToElement(a,b,c,d,IScroll.utils.ease[e])},goToPage:function(a,b,c,d){this.viewport.goToPage(a,b,c,IScroll.utils.ease[d])},next:function(){this.viewport.next()},prev:function(){this.viewport.prev()}}}};module.exports=i});